From a982a3c5ec3337fda3785ce72900df30643a69e5 Mon Sep 17 00:00:00 2001
From: Kartatz <105828205+Kartatz@users.noreply.github.com>
Date: Sun, 2 Nov 2025 15:47:24 -0300
Subject: [PATCH] Enable automatic linking of libiconv

---
 gcc/common.opt                |  4 ++++
 gcc/config.in                 |  5 +++++
 gcc/config/alpha/linux.h      |  2 +-
 gcc/config/arm/uclinux-elf.h  |  4 ++--
 gcc/config/arm/unknown-elf.h  |  2 +-
 gcc/config/avr/avrlibc.h      |  2 +-
 gcc/config/bfin/linux.h       |  2 +-
 gcc/config/darwin.h           |  2 +-
 gcc/config/gnu-user.h         |  2 +-
 gcc/config/lm32/uclinux-elf.h |  2 +-
 gcc/config/rs6000/linux64.h   |  4 ++--
 gcc/config/rs6000/rtems.h     |  4 ++--
 gcc/config/sparc/sparc.h      |  4 ++--
 gcc/configure                 | 23 +++++++++++++++++++++++
 gcc/configure.ac              | 16 ++++++++++++++++
 gcc/gcc.cc                    | 11 +++++++++++
 16 files changed, 74 insertions(+), 15 deletions(-)

diff --git a/gcc/common.opt b/gcc/common.opt
index 487716120..e7cafe4f7 100644
--- a/gcc/common.opt
+++ b/gcc/common.opt
@@ -3397,6 +3397,10 @@ flink-libatomic
 Common Driver Var(flag_link_libatomic) Init(1)
 Enable linking of libatomic.
 
+flink-libiconv
+Common Driver Var(flag_link_libiconv) Init(1)
+Enable linking of libiconv.
+
 ; Positive if we should track variables, negative if we should run
 ; the var-tracking pass only to discard debug annotations, zero if
 ; we're not to run it.
diff --git a/gcc/config.in b/gcc/config.in
index b2aa816fb..7ec0ede1f 100644
--- a/gcc/config.in
+++ b/gcc/config.in
@@ -2613,6 +2613,11 @@
 #undef TARGET_PROVIDES_LIBATOMIC
 #endif
 
+/* Define if the target provides the iconv routines in an external libiconv library rather than in libc. */
+#ifndef USED_FOR_TARGET
+#undef TARGET_PROVIDES_LIBICONV
+#endif
+
 
 /* Define to 1 if you can safely include both <sys/time.h> and <time.h>. */
 #ifndef USED_FOR_TARGET
diff --git a/gcc/config/alpha/linux.h b/gcc/config/alpha/linux.h
index 758817a1c..e20b13a0f 100644
--- a/gcc/config/alpha/linux.h
+++ b/gcc/config/alpha/linux.h
@@ -110,7 +110,7 @@ along with GCC; see the file COPYING3.  If not see
    %{shared|pie:crtendS.o%s;:crtend.o%s} crtn.o%s"
 
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
+  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
    %{static|static-pie:--end-group}%{!static:%{!static-pie:%G}}"
 
 /* Use --as-needed -lgcc_s for eh support.  */
diff --git a/gcc/config/arm/uclinux-elf.h b/gcc/config/arm/uclinux-elf.h
index d7b99f5ff..8d852d3ce 100644
--- a/gcc/config/arm/uclinux-elf.h
+++ b/gcc/config/arm/uclinux-elf.h
@@ -67,9 +67,9 @@
 
 #undef LINK_GCC_C_SEQUENCE_SPEC
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
+  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
    %{static|static-pie:--end-group}%{!static:%{!static-pie:%G %{!nolibc:" \
-   LINK_LIBATOMIC_SPEC "%L}}}"
+   LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L}}}"
 
 /* Use --as-needed -lgcc_s for eh support.  */
 #ifdef HAVE_LD_AS_NEEDED
diff --git a/gcc/config/arm/unknown-elf.h b/gcc/config/arm/unknown-elf.h
index a796d8702..f116380ec 100644
--- a/gcc/config/arm/unknown-elf.h
+++ b/gcc/config/arm/unknown-elf.h
@@ -93,4 +93,4 @@
    udivmoddi4, which will depend on the exception unwind routines,
    which will depend on abort, which is defined in libc.  */
 #undef LINK_GCC_C_SEQUENCE_SPEC
-#define LINK_GCC_C_SEQUENCE_SPEC "--start-group %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} --end-group"
+#define LINK_GCC_C_SEQUENCE_SPEC "--start-group %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} --end-group"
diff --git a/gcc/config/avr/avrlibc.h b/gcc/config/avr/avrlibc.h
index 0e87fc4b8..6450c5e24 100644
--- a/gcc/config/avr/avrlibc.h
+++ b/gcc/config/avr/avrlibc.h
@@ -36,4 +36,4 @@ along with GCC; see the file COPYING3.  If not see
 
 #undef  LINK_GCC_C_SEQUENCE_SPEC
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "--start-group %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} --end-group"
+  "--start-group %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} --end-group"
diff --git a/gcc/config/bfin/linux.h b/gcc/config/bfin/linux.h
index b75997987..a58d144ac 100644
--- a/gcc/config/bfin/linux.h
+++ b/gcc/config/bfin/linux.h
@@ -35,7 +35,7 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
 
 #undef LINK_GCC_C_SEQUENCE_SPEC
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "%{static|static-pie:--start-group} %{mfast-fp:-lbffastfp} %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
+  "%{static|static-pie:--start-group} %{mfast-fp:-lbffastfp} %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
    %{static|static-pie:--end-group} \
    %{!static:%{!static-pie:%{mfast-fp:-lbffastfp} %G}}"
 
diff --git a/gcc/config/darwin.h b/gcc/config/darwin.h
index bf76b87a3..f43c3e037 100644
--- a/gcc/config/darwin.h
+++ b/gcc/config/darwin.h
@@ -470,7 +470,7 @@ extern GTY(()) int darwin_ms_struct;
    depend on libgcc. */
 #undef  LINK_GCC_C_SEQUENCE_SPEC
 #define LINK_GCC_C_SEQUENCE_SPEC \
- "%G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} "
+ "%G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} "
 
 /* ld64 supports a sysroot, it just has a different name and there's no easy
    way to check for it at config time.  */
diff --git a/gcc/config/gnu-user.h b/gcc/config/gnu-user.h
index 151871540..abfdd3730 100644
--- a/gcc/config/gnu-user.h
+++ b/gcc/config/gnu-user.h
@@ -111,7 +111,7 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
 
 
 #define GNU_USER_TARGET_LINK_GCC_C_SEQUENCE_SPEC \
-  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
+  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
    %{static|static-pie:--end-group}%{!static:%{!static-pie:%G}}"
 
 #undef LINK_GCC_C_SEQUENCE_SPEC
diff --git a/gcc/config/lm32/uclinux-elf.h b/gcc/config/lm32/uclinux-elf.h
index 1926e26ae..a06455a33 100644
--- a/gcc/config/lm32/uclinux-elf.h
+++ b/gcc/config/lm32/uclinux-elf.h
@@ -69,7 +69,7 @@
 
 #undef LINK_GCC_C_SEQUENCE_SPEC
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
+  "%{static|static-pie:--start-group} %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
    %{static|static-pie:--end-group}%{!static:%{!static-pie:%G}}"
 
 #undef  CC1_SPEC
diff --git a/gcc/config/rs6000/linux64.h b/gcc/config/rs6000/linux64.h
index dd4d3f1f2..db564673b 100644
--- a/gcc/config/rs6000/linux64.h
+++ b/gcc/config/rs6000/linux64.h
@@ -393,9 +393,9 @@ extern int dot_symbols;
 /* Use gnu-user.h LINK_GCC_SEQUENCE_SPEC for linux.  */
 #undef LINK_GCC_C_SEQUENCE_SPEC
 #define	LINK_GCC_C_SEQUENCE_SPEC \
-  "%{mads|myellowknife|mmvme|msim:%G" LINK_LIBATOMIC_SPEC "%L %G;" \
+  "%{mads|myellowknife|mmvme|msim:%G" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L %G;" \
   "!mcall-*|mcall-linux:" GNU_USER_TARGET_LINK_GCC_C_SEQUENCE_SPEC ";" \
-  ":%G" LINK_LIBATOMIC_SPEC "%L %G}"
+  ":%G" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L %G}"
 
 #undef  TOC_SECTION_ASM_OP
 #define TOC_SECTION_ASM_OP \
diff --git a/gcc/config/rs6000/rtems.h b/gcc/config/rs6000/rtems.h
index a7b8f0f3c..ddce5010b 100644
--- a/gcc/config/rs6000/rtems.h
+++ b/gcc/config/rs6000/rtems.h
@@ -297,9 +297,9 @@
 /* Use gnu-user.h LINK_GCC_SEQUENCE_SPEC for rtems.  */
 #undef LINK_GCC_C_SEQUENCE_SPEC
 #define	LINK_GCC_C_SEQUENCE_SPEC \
-  "%{mads|myellowknife|mmvme|msim:%G" LINK_LIBATOMIC_SPEC "%L %G;" \
+  "%{mads|myellowknife|mmvme|msim:%G" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L %G;" \
   "!mcall-*|mcall-linux:" GNU_USER_TARGET_LINK_GCC_C_SEQUENCE_SPEC ";" \
-  ":%G" LINK_LIBATOMIC_SPEC "%L %G}"
+  ":%G" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L %G}"
 
 #define RTEMS_STARTFILE_SPEC "ecrti%O%s rtems_crti%O%s crtbegin%O%s"
 #define RTEMS_ENDFILE_SPEC "crtend%O%s rtems_crtn%O%s ecrtn%O%s"
diff --git a/gcc/config/sparc/sparc.h b/gcc/config/sparc/sparc.h
index 48ddb3d96..aab96d76c 100644
--- a/gcc/config/sparc/sparc.h
+++ b/gcc/config/sparc/sparc.h
@@ -410,8 +410,8 @@ along with GCC; see the file COPYING3.  If not see
 /* Because libgcc can generate references back to libc (via .umul etc.) we have
    to list libc again after the second libgcc.  */
 #define LINK_GCC_C_SEQUENCE_SPEC \
-  "%G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L} \
-  %G %{!nolibc:" LINK_LIBATOMIC_SPEC "%L}"
+  "%G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L} \
+  %G %{!nolibc:" LINK_LIBATOMIC_SPEC LINK_LIBICONV_SPEC "%L}"
 
 
 #define PTRDIFF_TYPE (TARGET_ARCH64 ? "long int" : "int")
diff --git a/gcc/configure b/gcc/configure
index 2f6d0f349..c6a00c25b 100755
--- a/gcc/configure
+++ b/gcc/configure
@@ -730,6 +730,7 @@ zlibinc
 zlibdir
 HOST_LIBS
 enable_default_ssp
+enable_autolink_libiconv
 thin_archive_support
 ld_soname_option
 ld_version_script_option
@@ -33492,6 +33493,28 @@ $as_echo "#define ENABLE_DEFAULT_SSP 1" >>confdefs.h
 fi
 
 
+# Check whether --enable-autolink-libiconv was given.
+if test "${enable_autolink_libiconv+set}" = set; then :
+  enableval=$enable_autolink_libiconv; case "${enableval}" in
+  yes|no)
+    enable_autolink_libiconv=$enableval
+    ;;
+  *)
+    as_fn_error $? "unknown autolink-libiconv setting $enableval" "$LINENO" 5
+    ;;
+esac
+else
+  enable_autolink_libiconv=no
+fi
+
+
+if test x$enable_autolink_libiconv = xyes ; then
+
+$as_echo "#define TARGET_PROVIDES_LIBICONV 1" >>confdefs.h
+
+fi
+
+
 if echo " ${TARGET_CONFIGDIRS} " | grep " libatomic " > /dev/null 2>&1 ; then
 
 $as_echo "#define TARGET_PROVIDES_LIBATOMIC 1" >>confdefs.h
diff --git a/gcc/configure.ac b/gcc/configure.ac
index 06fa6078d..f05425152 100644
--- a/gcc/configure.ac
+++ b/gcc/configure.ac
@@ -7024,6 +7024,22 @@ if test x$enable_default_ssp = xyes ; then
 fi
 AC_SUBST([enable_default_ssp])
 
+AC_ARG_ENABLE(autolink-libiconv,
+[AS_HELP_STRING([--enable-autolink-libiconv], [enable automatic linking against libiconv])],
+[case "${enableval}" in
+  yes|no)
+    enable_autolink_libiconv=$enableval
+    ;;
+  *)
+    AC_MSG_ERROR([unknown autolink-libiconv setting $enableval])
+    ;;
+esac], [enable_autolink_libiconv=no])
+
+if test x$enable_autolink_libiconv = xyes ; then
+  AC_DEFINE(TARGET_PROVIDES_LIBICONV, 1,
+      [Define if the target provides the iconv routines in an external libiconv library rather than in libc.])
+fi
+
 if echo " ${TARGET_CONFIGDIRS} " | grep " libatomic " > /dev/null 2>&1 ; then
   AC_DEFINE(TARGET_PROVIDES_LIBATOMIC, 1,
 	    [Define if libatomic is built for the target.])
diff --git a/gcc/gcc.cc b/gcc/gcc.cc
index 4a804ba96..112c67512 100644
--- a/gcc/gcc.cc
+++ b/gcc/gcc.cc
@@ -995,6 +995,17 @@ proper position among the other output files.  */
 #define LINK_LIBATOMIC_SPEC ""
 #endif
 
+#if defined(TARGET_PROVIDES_LIBICONV) && defined(USE_LD_AS_NEEDED)
+#if defined(USE_LD_AS_NEEDED_LDSCRIPT)
+#define LINK_LIBICONV_SPEC "%{!fno-link-libiconv:-liconv_asneeded -lcharset_asneeded} "
+#else
+#define LINK_LIBICONV_SPEC "%{!fno-link-libiconv:" LD_AS_NEEDED_OPTION \
+			    " -liconv -lcharset " LD_NO_AS_NEEDED_OPTION "} "
+#endif
+#else
+#define LINK_LIBICONV_SPEC ""
+#endif
+
 /* This is overridable by the target in case they need to specify the
    -lgcc and -lc order specially, yet not require them to override all
    of LINK_COMMAND_SPEC.  */
-- 
2.52.0

